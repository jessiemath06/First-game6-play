<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Jessie Mathï½œå…­å¹´ç´šå…©é‡é—œä¿‚ï¼šæ°£çƒå¤§æŒ‘æˆ°</title>

  <!-- Fonts / Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600;700;800&family=Noto+Sans+TC:wght@500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    :root{
      --bg-sky:#87CEEB;
      --card: rgba(255,255,255,.92);
      --shadow: 0 14px 40px rgba(15, 23, 42, 0.14);

      --ink:#0f172a;
      --muted:#475569;

      --brand:#6366f1;
      --yellow2:#f59e0b;

      --ok:#16a34a;
      --bad:#ef4444;

      --brown:#5D4037;
      --basket:#8D6E63;

      --pill: 999px;

      --heroH: 86px;
      --footerH: 88px;

      --panelSafeTop: 210px;

      --balloonMinGap: 96px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: "Noto Sans TC", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: var(--bg-sky);
      color: var(--ink);
      overflow:hidden;
      touch-action:none;
    }

    /* ========= HERO ========= */
    .hero{
      position: fixed;
      top: 0; left: 0; right: 0;
      height: var(--heroH);
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 26px rgba(15,23,42,.10);
      z-index: 999;
    }
    .hero .wrap{
      height: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 14px;
    }
    .brandBox{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 210px;
    }
    .avatarRing{
      width: 48px; height: 48px;
      border-radius: 999px;
      border: 4px solid var(--yellow2);
      background: #fff;
      display:grid;
      place-items:center;
      overflow:hidden;
      flex: 0 0 auto;
      box-shadow: 0 10px 22px rgba(245,158,11,.18);
    }
    .avatarRing img{
      width: 88%;
      height: 88%;
      object-fit: contain;
      display:block;
      background: transparent;
    }
    .brandText{
      display:flex;
      flex-direction:column;
      line-height:1.05;
    }
    .brandText .title{
      font-family: "Fredoka", "Noto Sans TC", sans-serif;
      font-weight: 800;
      font-size: 28px;
      letter-spacing: .2px;
      color: #111827;
    }
    .brandText .sub{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      margin-top: 2px;
    }

    .nav{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .nav a{
      text-decoration:none;
      color: #111827;
      font-weight: 900;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: var(--pill);
      background: #fff;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 22px rgba(15,23,42,.08);
      transition: transform .08s ease;
      white-space: nowrap;
    }
    .nav a:hover{ transform: translateY(-1px); }
    .nav a .ico{
      width: 26px; height: 26px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      background: rgba(99,102,241,.12);
      color: var(--brand);
    }
    .nav a.primary{
      border: 2px solid rgba(99,102,241,.45);
      color: var(--brand);
    }
    .nav a.primary .ico{
      background: rgba(99,102,241,.14);
      color: var(--brand);
    }

    /* ========= åå­—é–€ ========= */
    #nameGate{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 2000;
      padding: 16px;
    }
    .gateCard{
      width: min(520px, 92vw);
      background: rgba(255,255,255,.96);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 18px 16px;
      text-align:center;
      backdrop-filter: blur(10px);
    }
    .gateTitle{
      font-family:"Fredoka","Noto Sans TC",sans-serif;
      font-weight: 800;
      font-size: 22px;
      margin-bottom: 8px;
    }
    .gateSub{
      opacity:.86;
      margin-bottom: 12px;
      line-height:1.35;
      font-size: 14px;
      font-weight:700;
      color: var(--muted);
    }
    .gateRow{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
    }
    #playerName{
      width: min(320px, 78vw);
      padding: 12px 12px;
      border-radius: 14px;
      border: 2px solid rgba(31,41,55,.15);
      font-size: 16px;
      outline:none;
      font-weight: 800;
    }
    #startBtn{
      padding: 12px 14px;
      border-radius: 14px;
      border: none;
      background: #111827;
      color:#fff;
      font-weight: 900;
      cursor:pointer;
    }
    #gateMsg{
      margin-top: 10px;
      color: var(--bad);
      font-weight: 900;
      min-height: 22px;
    }

    /* ========= éŠæˆ²å¤©ç©º ========= */
    #sky{
      width:100vw;
      height:100vh;
      position:relative;
      padding-top: calc(var(--heroH) + 10px);
      padding-bottom: calc(var(--footerH) + 14px);
      overflow:hidden;
    }

    /* ========= é¡Œç›®é¢æ¿ ========= */
    #game-ui{
      position:absolute;
      top: calc(var(--heroH) + 10px);
      left: 0; right: 0;
      display:flex;
      justify-content:center;
      z-index: 80;
      pointer-events:none;
      padding: 0 10px;
    }
    .panel{
      background: var(--card);
      padding: 14px 16px;
      border-radius: 18px;
      box-shadow: var(--shadow);
      max-width: min(980px, 94vw);
      backdrop-filter: blur(8px);
      pointer-events:auto;
      border: 1px solid rgba(15,23,42,.10);
      position:relative;
    }
    #quest{
      font-weight: 900;
      font-size: clamp(15px, 2.1vw, 22px);
      line-height: 1.35;
    }
    #msg{
      margin-top: 8px;
      font-weight: 900;
      font-size: clamp(14px, 1.9vw, 18px);
      color: #111827;
    }

    .scoreBar{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: var(--pill);
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 22px rgba(15,23,42,.08);
      font-weight: 900;
      user-select:none;
      pointer-events:auto;
    }
    .pill .tag{opacity:.75;font-weight:900}
    .pill b{font-size: 15px}
    .btnMini{
      border:none;
      border-radius: var(--pill);
      padding: 9px 12px;
      font-weight: 900;
      cursor:pointer;
      pointer-events:auto;
      color:#fff;
      background:#111827;
      transition: transform .08s ease;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .btnMini:active{transform:scale(.98)}
    #openBoard{ background: #2563eb; }
    #resetGame{ background: #0f172a; }
    #pauseGame{ background: #f59e0b; color:#111827; }

    /* ========= ç±ƒå­ ========= */
    .basket-container{
      position:absolute;
      left:0; right:0;
      bottom: calc(var(--footerH) + 6px);
      display:flex;
      justify-content: space-around;
      gap: 10px;
      padding: 0 10px;
      z-index: 20;
      pointer-events:none;
    }
    .basket{
      width: min(220px, 30vw);
      height: min(140px, 18vh);
      border: 5px solid var(--brown);
      background: var(--basket);
      border-radius: 0 0 22px 22px;
      position:relative;
      color:#fff;
      text-align:center;
      box-shadow: var(--shadow);
      pointer-events:auto;
      z-index: 10;
    }
    .basket::before{
      content:'';
      position:absolute;
      top: -42px; left: 10%;
      width: 80%; height: 42px;
      border: 4px solid var(--brown);
      border-bottom:none;
      border-radius: 22px 22px 0 0;
    }
    .basket-label{
      margin-top: 44px;
      font-weight: 900;
      font-size: clamp(14px, 1.8vw, 18px);
      letter-spacing: .5px;
      padding: 0 6px;
      user-select:none;
    }
    .basket-sub{
      font-size: 12px;
      opacity: .9;
      margin-top: 4px;
      user-select:none;
    }
    .basket.glow-ok{ outline: 3px solid rgba(22,163,74,.35); box-shadow: 0 0 0 6px rgba(22,163,74,.16), var(--shadow); }
    .basket.glow-bad{ outline: 3px solid rgba(239,68,68,.35); box-shadow: 0 0 0 6px rgba(239,68,68,.14), var(--shadow); }

    /* ========= æ°£çƒ ========= */
    .balloon{
      position:absolute;
      cursor: grab;
      user-select:none;
      display:flex;
      flex-direction: column;
      align-items:center;
      z-index: 12;
      will-change: transform, left, top;
    }
    .balloon.dragging{ cursor: grabbing; z-index: 999; }
    .balloon.placed{ pointer-events:none; opacity: .62; filter: saturate(.92); }
    .balloon-body{
      width: clamp(58px, 7vw, 76px);
      height: clamp(72px, 9vw, 92px);
      border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight: 900;
      font-size: clamp(14px, 2vw, 18px);
      text-shadow: 0 2px 6px rgba(0,0,0,.22);
      box-shadow: inset -6px -6px 14px rgba(0,0,0,.18), 0 10px 18px rgba(0,0,0,.14);
      padding: 0 10px;
      text-align:center;
      line-height: 1.1;
      border: 1px solid rgba(255,255,255,.22);
      white-space: nowrap;
    }
    .balloon-string{
      width: 2px;
      height: 42px;
      background: rgba(255,255,255,.78);
      border-radius: 3px;
      margin-top: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
    }

    /* ========= æ’è¡Œæ¦œ Modal ========= */
    #boardModal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1999;
      padding: 16px;
    }
    .boardCard{
      width:min(720px, 94vw);
      background: rgba(255,255,255,.96);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(15,23,42,.10);
    }
    .boardTop{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .boardTitle{
      font-family:"Fredoka","Noto Sans TC",sans-serif;
      font-weight: 800;
      font-size: 20px;
    }
    .closeBtn{
      border:none;
      border-radius: var(--pill);
      padding: 9px 12px;
      font-weight: 900;
      cursor:pointer;
      background:#111827;
      color:#fff;
    }
    .boardHint{
      margin-top: 8px;
      opacity:.85;
      font-size: 14px;
      line-height: 1.35;
      color: var(--muted);
      font-weight: 700;
    }
    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      overflow:hidden;
      border-radius: 14px;
    }
    th, td{
      text-align:left;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(15,23,42,.10);
      font-size: 14px;
    }
    th{
      background: rgba(99,102,241,.10);
      font-weight: 900;
    }
    tr:last-child td{border-bottom:none}
    .rankBadge{
      display:inline-block;
      min-width: 28px;
      text-align:center;
      padding: 4px 8px;
      border-radius: var(--pill);
      font-weight: 900;
      background: rgba(245,158,11,.18);
      border: 1px solid rgba(245,158,11,.35);
    }

    /* ========= Footer ========= */
    footer{
      position: fixed;
      left: 0; right: 0;
      bottom: 10px;
      z-index: 60;
      padding: 0 10px;
      pointer-events:none;
    }
    .footer-pill{
      max-width: 1200px;
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 24px rgba(15,23,42,.10);
      border: 1px solid rgba(15,23,42,.10);
      pointer-events:auto;
      backdrop-filter: blur(10px);
    }
    .footer-left, .footer-right{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .footer-dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--yellow2);
      box-shadow: 0 0 0 6px rgba(245,158,11,.14);
      flex: 0 0 auto;
    }
    .footer-copy{
      font-weight: 900;
      color: #111827;
      font-size: 13px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 52vw;
    }
    .footer-icon{
      width: 28px; height: 28px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      background: rgba(99,102,241,.12);
      color: var(--brand);
      flex: 0 0 auto;
    }
    .footer-tagline{
      font-weight: 900;
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 44vw;
    }

    /* ========= æš«åœé®ç½© ========= */
    #pauseOverlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1500;
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      padding: 16px;

      /* âœ… ä¿®æ­£ï¼šé®ç½©ä¸åƒé»æ“Šï¼Œæ‰èƒ½å†æŒ‰ä¸€æ¬¡ã€Œæš«åœ/ç¹¼çºŒã€ */
      pointer-events:none;
    }
    .pauseCard{
      width: min(520px, 92vw);
      background: rgba(255,255,255,.96);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 16px;
      text-align:center;
      border: 1px solid rgba(15,23,42,.10);

      /* âœ… ä¿æŒä¸€è‡´ï¼šå¡ç‰‡ä¹Ÿä¸åƒé»æ“Š */
      pointer-events:none;
    }
    .pauseTitle{
      font-family:"Fredoka","Noto Sans TC",sans-serif;
      font-weight: 800;
      font-size: 20px;
    }
    .pauseSub{
      margin-top: 6px;
      font-weight: 800;
      color: var(--muted);
    }

    /* ========= RWD ========= */
    @media (max-width: 860px){
      :root{ --heroH: 96px; --footerH: 96px; --panelSafeTop: 235px; --balloonMinGap: 88px; }
      .brandText .title{ font-size: 26px; }
      .brandText .sub{ display:none; }
      .nav a{ padding: 9px 12px; }
      .footer-pill{ border-radius: 18px; flex-direction: column; align-items:flex-start; }
      .footer-copy, .footer-tagline{ max-width: 100%; }
    }
    @media (max-width: 520px){
      :root{ --heroH: 108px; --footerH: 110px; --panelSafeTop: 260px; --balloonMinGap: 78px; }
      .hero .wrap{ padding: 12px 12px; }
      .brandText .title{ font-size: 24px; }
      .nav{ gap: 8px; }
      .scoreBar{ justify-content:center; }
      .basket-container{ justify-content: space-between; }
      .basket{ width: 31vw; height: 16vh; }
      .basket::before{ top: -36px; height: 36px; }
      .basket-label{ margin-top: 40px; }
    }
  </style>
</head>

<body>
  <!-- HERO -->
  <header class="hero" role="banner" aria-label="Jessie Math å°è¦½åˆ—">
    <div class="wrap">
      <div class="brandBox">
        <div class="avatarRing" aria-hidden="true">
          <img src="JESSIEMATH-Q.png" alt="Jessie Math avatar">
        </div>
        <div class="brandText">
          <div class="title">Jessie Math</div>
          <div class="sub">å…­å¹´ç´šï½œå…©é‡é—œä¿‚èˆ‡æ¯”</div>
        </div>
      </div>

      <nav class="nav" aria-label="ç¶²ç«™å°è¦½">
        <a href="https://jessiemath0703-chu.github.io/website2/" target="_self" rel="noopener">
          <span class="ico" aria-hidden="true"><i class="fa-solid fa-house"></i></span>
          <span>é¦–é </span>
        </a>
        <a href="https://jessiemath0703-chu.github.io/Game-Lobby/" target="_self" rel="noopener">
          <span class="ico" aria-hidden="true"><i class="fa-solid fa-gamepad"></i></span>
          <span>éŠæˆ²å¤§å»³</span>
        </a>
        <a class="primary" href="https://jessiemath0703-chu.github.io/Game-Lobby/#g6-u6" target="_self" rel="noopener">
          <span class="ico" aria-hidden="true"><i class="fa-solid fa-rotate-left"></i></span>
          <span>å…­å¹´ç´šåŸºæº–é‡èˆ‡æ¯”è¼ƒé‡</span>
        </a>
      </nav>
    </div>
  </header>

  <!-- å¼·åˆ¶è¼¸å…¥åå­— -->
  <div id="nameGate" aria-label="è¼¸å…¥åå­—é–‹å§‹éŠæˆ²">
    <div class="gateCard">
      <div class="gateTitle">å…ˆè¼¸å…¥åå­—å†é–‹ç© âœï¸</div>
      <div class="gateSub">æ’è¡Œæ¦œè¦è¨˜éŒ„ä½ æœ‰å¤šç¥ã€‚åå­—å¿…å¡«ã€‚</div>
      <div class="gateRow">
        <input id="playerName" type="text" maxlength="16" placeholder="è¼¸å…¥ä½ çš„åå­—ï¼ˆå¿…å¡«ï¼‰" autocomplete="off" />
        <button id="startBtn">é–‹å§‹éŠæˆ²</button>
      </div>
      <div id="gateMsg"></div>
    </div>
  </div>

  <!-- æ’è¡Œæ¦œ -->
  <div id="boardModal" aria-label="æ’è¡Œæ¦œ">
    <div class="boardCard">
      <div class="boardTop">
        <div class="boardTitle">ğŸ† æ’è¡Œæ¦œï¼ˆæœ¬æ©Ÿï¼‰</div>
        <button class="closeBtn" id="closeBoard">é—œé–‰</button>
      </div>
      <div class="boardHint">æ’åºï¼šåˆ†æ•¸é«˜å„ªå…ˆï¼›åŒåˆ†æ™‚ã€Œå‰©é¤˜ç§’æ•¸å¤šã€å„ªå…ˆã€‚è³‡æ–™å­˜ä½ çš„ç€è¦½å™¨ã€‚</div>
      <div id="boardTable"></div>
    </div>
  </div>

  <main id="sky" aria-label="éŠæˆ²å¤©ç©º">
    <!-- æš«åœé®ç½© -->
    <div id="pauseOverlay" aria-label="æš«åœä¸­">
      <div class="pauseCard">
        <div class="pauseTitle">â¸ï¸ å·²æš«åœ</div>
        <div class="pauseSub">æŒ‰ã€Œæš«åœã€å†ä¸€æ¬¡å³å¯ç¹¼çºŒã€‚</div>
      </div>
    </div>

    <!-- é¡Œç›®é¢æ¿ -->
    <div id="game-ui">
      <div class="panel">
        <div id="quest">è¼‰å…¥é¡Œç›®ä¸­...</div>
        <div id="msg">å…ˆåˆ¤æ–·èª°æ˜¯åŸºæº–é‡(1)ã€èª°æ˜¯æ¯”è¼ƒé‡ï¼Œå†æŠŠã€ç®—å¼ã€ä¹Ÿé€é€²ç±ƒå­ã€‚</div>

        <div class="scoreBar">
          <div class="pill"><span class="tag">ç©å®¶</span><b id="uiName">â€”</b></div>
          <div class="pill"><span class="tag">å€’æ•¸</span><b id="uiTime">01:00</b></div>
          <div class="pill"><span class="tag">åˆ†æ•¸</span><b id="uiScore">0</b></div>
          <button class="btnMini" id="openBoard"><i class="fa-solid fa-trophy"></i>æ’è¡Œæ¦œ</button>
          <button class="btnMini" id="pauseGame"><i class="fa-solid fa-pause"></i>æš«åœ</button>
          <button class="btnMini" id="resetGame"><i class="fa-solid fa-rotate-right"></i>é‡ä¾†</button>
        </div>
      </div>
    </div>

    <!-- ç±ƒå­ -->
    <div class="basket-container" aria-label="ç±ƒå­å€">
      <div id="basket-ref" class="basket">
        <div class="basket-label">åŸºæº–é‡ (1)</div>
        <div class="basket-sub">èª°è¢«ç•¶ä½œ 1</div>
      </div>
      <div id="basket-comp" class="basket">
        <div class="basket-label">æ¯”è¼ƒé‡</div>
        <div class="basket-sub">è¢«æ‹¿ä¾†æ¯”è¼ƒçš„é‚£å€‹</div>
      </div>
      <div id="basket-val" class="basket">
        <div class="basket-label">ç®—å¼</div>
        <div class="basket-sub">ç”¨ Ã· ä¾†è¡¨ç¤º</div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <div class="footer-pill">
      <div class="footer-left">
        <div class="footer-dot" aria-hidden="true"></div>
        <div class="footer-copy">Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.</div>
      </div>
      <div class="footer-right">
        <div class="footer-icon" aria-hidden="true"><i class="fas fa-compass"></i></div>
        <div class="footer-tagline">æ•¸å­¸ä¸è¿·è·¯ï¼ŒJessie å¸¶ä½ èµ°å‘ç†è§£ã€‚</div>
      </div>
    </div>
  </footer>

<script>
/* ===================== DOM ===================== */
const sky = document.getElementById('sky');
const questText = document.getElementById('quest');
const msgText = document.getElementById('msg');

const basketEls = {
  ref: document.getElementById('basket-ref'),
  comp: document.getElementById('basket-comp'),
  val: document.getElementById('basket-val'),
};

const uiName = document.getElementById('uiName');
const uiTime = document.getElementById('uiTime');
const uiScore = document.getElementById('uiScore');

const gate = document.getElementById("nameGate");
const nameInput = document.getElementById("playerName");
const startBtn = document.getElementById("startBtn");
const gateMsg = document.getElementById("gateMsg");

const boardModal = document.getElementById('boardModal');
const openBoardBtn = document.getElementById('openBoard');
const closeBoardBtn = document.getElementById('closeBoard');
const boardTable = document.getElementById('boardTable');

const resetBtn = document.getElementById('resetGame');
const pauseBtn = document.getElementById('pauseGame');
const pauseOverlay = document.getElementById('pauseOverlay');

/* ---------- å°å·¥å…· ---------- */
function rndInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function rndPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
function fmtTime(sec){
  const s = Math.max(0, Math.floor(sec));
  const m = Math.floor(s/60);
  const r = s%60;
  return String(m).padStart(2,"0")+":"+String(r).padStart(2,"0");
}
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[s]));
}

/* ========== âœ… æ¯”å€¼ï¼šå¥½ç®—å°±çµ¦ã€Œç­”æ¡ˆã€ï¼Œä¸å¥½ç®—å°±çµ¦ã€Œç®—å¼ã€ ========== */
function fmtValAnswer(n, d){
  if(d !== 0 && Number.isFinite(n) && Number.isFinite(d) && Math.abs(n % d) === 0){
    return String(n / d);
  }
  return `${n}Ã·${d}`;
}
function valAcceptSet(n, d){
  const set = new Set();
  set.add(`${n}Ã·${d}`);
  if(d !== 0 && Math.abs(n % d) === 0) set.add(String(n / d));
  return Array.from(set);
}

/* ---------- âœ… å»ºæ°£çƒï¼šç¸½æ•¸æœ€å¤š 10 é¡† ---------- */
function buildBalloons({refTxt, compTxt, valBalloons, extraTraps=[]}){
  const MAX_BALLOONS = 10;

  const requiredVal = (valBalloons && valBalloons.length) ? String(valBalloons[0]) : "1Ã·1";
  const out = [
    { txt: String(refTxt), target:"ref" },
    { txt: String(compTxt), target:"comp" },
    { txt: requiredVal,   target:"val" },
  ];

  const maybe = [
    "1Ã·2","2Ã·1","3Ã·2","2Ã·3","4Ã·5","5Ã·4","6Ã·5","5Ã·6",
    "1Ã·3","3Ã·1","2Ã·4","4Ã·2","7Ã·5","5Ã·7","9Ã·6","6Ã·9"
  ];

  const pool = [
    { txt: String(refTxt),  target:"ref" },
    { txt: String(compTxt), target:"comp" },
    ...extraTraps.map(t => ({ txt: String(t), target:"val" })),
    { txt: "æ¯”è¼ƒé‡", target:"comp" },
    { txt: "åŸºæº–é‡", target:"ref" },
    { txt: "æ¯”å€¼",   target:"val" },
    { txt: "å€æ•¸",   target:"val" },
    ...maybe.map(m => ({ txt: m, target:"val" })),
  ];

  for(let i=pool.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [pool[i], pool[j]] = [pool[j], pool[i]];
  }

  const used = new Set(out.map(x => `${x.target}|${x.txt}`));
  for(const item of pool){
    if(out.length >= MAX_BALLOONS) break;
    const key = `${item.target}|${item.txt}`;
    if(used.has(key)) continue;
    used.add(key);
    out.push(item);
  }

  while(out.length < Math.min(MAX_BALLOONS, 6)){
    const m = rndPick(maybe);
    const key = `val|${m}`;
    if(used.has(key)) continue;
    used.add(key);
    out.push({txt:m, target:"val"});
  }

  return out;
}

/* ---------- é¡Œå‹æ¨¡æ¿ï¼ˆé¡Œç›®ä¸æç¤ºã€ŒæŠŠèª°ç•¶ä½œ 1ã€ï¼‰---------- */
const PLACES = ["å…¬åœ’","å¥èº«ä¸­å¿ƒ","é»ƒæ˜å¸‚å ´","å¯ºå»Ÿ","å­¸æ ¡","åœ–æ›¸é¤¨"];
const FRUITS_A = ["è˜‹æœ","æ°´æ¢¨","é¦™è•‰","è‘¡è„"];

function makeQ_basic_multiple(){
  const d = rndPick([4,5,6,8,10,12,15,18,20,24,25,30]);
  const k = rndPick([2,3,4,5]);
  const n = d*k;
  const ref = String(d);
  const comp = String(n);

  const valBalloons = [fmtValAnswer(n, d)];
  const valAccept = valAcceptSet(n, d);
  const traps = [`${d}Ã·${n}`, `${n}Ã·${d+1}`, String(k), String(n), String(d)];

  return {
    text: `${comp} æ˜¯ ${ref} çš„å¹¾å€ï¼Ÿ`,
    correct: { ref, comp, valAccept },
    balloons: buildBalloons({ refTxt: ref, compTxt: comp, valBalloons, extraTraps: traps })
  };
}

function makeQ_money_siblings(){
  const a = rndPick([40,50,60,80,90,120,150,160,200,240]);
  const k = rndPick([2,3,4,5]);
  const b = a*k;

  const whoSmall = rndPick(["å§å§","å¼Ÿå¼Ÿ","å“¥å“¥","å¦¹å¦¹"]);
  const whoBig = rndPick(["å§å§","å¼Ÿå¼Ÿ","å“¥å“¥","å¦¹å¦¹"].filter(x=>x!==whoSmall));

  const valBalloons = [fmtValAnswer(a, b)];
  const valAccept = valAcceptSet(a, b);

  const traps = [`${b}Ã·${a}`, `${a}Ã·${b+a}`, String(k), String(a), String(b), `${a}Ã·${b-a}`];

  return {
    text: `${whoSmall} æœ‰ ${a} å…ƒï¼Œ${whoBig} æœ‰ ${b} å…ƒã€‚${whoSmall} çš„éŒ¢æ˜¯ ${whoBig} çš„å¹¾å€ï¼Ÿ`,
    correct: { ref: whoBig, comp: whoSmall, valAccept },
    balloons: buildBalloons({ refTxt: whoBig, compTxt: whoSmall, valBalloons, extraTraps: traps })
  };
}

function makeQ_percent_change(){
  const pct = rndPick([5,10,15,20]);
  const last = rndPick([1200,1500,1800,2000,2100,2400,3000]);
  const now = Math.round(last * (1 - pct/100));

  const valBalloons = [`${now}Ã·${last}`];
  const valAccept = [`${now}Ã·${last}`];

  const traps = [`${last}Ã·${now}`, `${now}Ã·${last+100}`, `${pct}%`, String(now), String(last)];

  return {
    text: `æŸæ ¡ä»Šå¹´å­¸ç”Ÿæœ‰ ${now} äººï¼Œæ¯”å»å¹´æ¸›å°‘ ${pct}%ã€‚ã€Œä»Šå¹´ã€ç›¸å°æ–¼ã€Œå»å¹´ã€çš„æ¯”å€¼ç®—å¼æ˜¯ï¼Ÿ`,
    correct: { ref: "å»å¹´", comp: "ä»Šå¹´", valAccept },
    balloons: buildBalloons({ refTxt: "å»å¹´", compTxt: "ä»Šå¹´", valBalloons, extraTraps: traps })
  };
}

function makeQ_fruit_weight(){
  const apple = rndPick([600,720,800,900,960,1200,1500]);
  const rate = rndPick([0.65,0.7,0.8,0.6,0.88]);
  const pear = Math.round(apple * rate);
  const A = rndPick(FRUITS_A);
  const B = rndPick(FRUITS_A.filter(x=>x!==A));

  const valBalloons = [`${pear}Ã·${apple}`];
  const valAccept = [`${pear}Ã·${apple}`];

  const traps = [`${apple}Ã·${pear}`, String(rate), String(apple), String(pear), `${pear}Ã·${apple+10}`];

  return {
    text: `æ°´æœè¡Œé€²è²¨ï¼š${A} æœ‰ ${apple} å…¬æ–¤ï¼Œ${B} çš„é‡é‡æ˜¯ ${A} çš„ ${rate} å€ï¼Œæ‰€ä»¥ ${B} æœ‰ ${pear} å…¬æ–¤ã€‚ã€Œ${B}ã€ç›¸å°æ–¼ã€Œ${A}ã€çš„æ¯”å€¼ç®—å¼æ˜¯ï¼Ÿ`,
    correct: { ref: A, comp: B, valAccept },
    balloons: buildBalloons({ refTxt: A, compTxt: B, valBalloons, extraTraps: traps })
  };
}

function makeQ_route_map_style(){
  const a = rndPick([1200,1400,1500,1600,1800,2000]);
  const b = rndPick([600,800,900,1000,1200]);
  const p1 = rndPick(PLACES);
  const p2 = rndPick(PLACES.filter(x=>x!==p1));

  const valBalloons = [fmtValAnswer(a, b)];
  const valAccept = valAcceptSet(a, b);

  const traps = [`${b}Ã·${a}`, `${a}Ã·${b+100}`, String(a), String(b), "è·¯ç·šç”²", "è·¯ç·šä¹™"];

  return {
    text: `åœ°åœ–ä¸Šï¼šè·¯ç·š${p1} é•· ${a} å…¬å°ºï¼Œè·¯ç·š${p2} é•· ${b} å…¬å°ºã€‚ã€Œè·¯ç·š${p1}ã€ç›¸å°æ–¼ã€Œè·¯ç·š${p2}ã€çš„æ¯”å€¼æ˜¯ï¼Ÿï¼ˆä¸å¥½ç®—å¯ç”¨ç®—å¼ï¼‰`,
    correct: { ref: `è·¯ç·š${p2}`, comp: `è·¯ç·š${p1}`, valAccept },
    balloons: buildBalloons({ refTxt: `è·¯ç·š${p2}`, compTxt: `è·¯ç·š${p1}`, valBalloons, extraTraps: traps })
  };
}

const QUESTION_BUILDERS = [
  makeQ_basic_multiple,
  makeQ_money_siblings,
  makeQ_percent_change,
  makeQ_fruit_weight,
  makeQ_route_map_style,
];

function makeQuestion(){
  if(!makeQuestion._last) makeQuestion._last = -1;
  let idx = rndInt(0, QUESTION_BUILDERS.length-1);
  if(idx === makeQuestion._last) idx = (idx+1) % QUESTION_BUILDERS.length;
  makeQuestion._last = idx;
  return QUESTION_BUILDERS[idx]();
}

/* ===================== éŠæˆ²ç‹€æ…‹ ===================== */
let playerName = "";
let score = 0;

const ROUND_SECONDS = 60;
let remain = ROUND_SECONDS;
let timerId = null;

let running = false;
let paused = false;

let placedNeeded = new Set();
let currentQuestion = null;

/* ===================== åˆ†æ•¸/é¡¯ç¤º ===================== */
function setScore(v){
  score = Math.max(0, v);
  uiScore.textContent = String(score);
}
function addScore(delta){ setScore(score + delta); }

/* ===================== å€’æ•¸è¨ˆæ™‚ ===================== */
function stopTimer(){
  if(timerId){ clearInterval(timerId); timerId = null; }
}
function startTimer(){
  stopTimer();
  remain = ROUND_SECONDS;
  uiTime.textContent = fmtTime(remain);
  timerId = setInterval(()=>{
    if(!running || paused) return;
    remain -= 1;
    uiTime.textContent = fmtTime(remain);
    if(remain <= 0) endGame();
  }, 1000);
}

/* ===================== æ’è¡Œæ¦œ ===================== */
const LB_KEY = "JM_G6_RATIO_BALLOON_LB_V4";
function loadLB(){
  try{
    const raw = localStorage.getItem(LB_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}
function saveLB(arr){ localStorage.setItem(LB_KEY, JSON.stringify(arr)); }
function upsertScore(entry){
  const arr = loadLB();
  arr.push(entry);
  arr.sort((a,b)=>{
    if(b.score !== a.score) return b.score - a.score;
    if(b.remain !== a.remain) return b.remain - a.remain;
    return b.ts - a.ts;
  });
  saveLB(arr.slice(0, 20));
}
function renderLB(){
  const arr = loadLB();
  if(arr.length === 0){
    boardTable.innerHTML = `<div style="padding:12px;font-weight:900;opacity:.8;">é‚„æ²’æœ‰ç´€éŒ„ï½ç¬¬ä¸€å€‹ä¸Šæ¦œçš„äººå°±æ˜¯ä½  âœ¨</div>`;
    return;
  }
  let html = `
    <table>
      <thead>
        <tr>
          <th style="width:70px;">åæ¬¡</th>
          <th>ç©å®¶</th>
          <th style="width:120px;">åˆ†æ•¸</th>
          <th style="width:140px;">å‰©é¤˜æ™‚é–“</th>
          <th style="width:140px;">æ—¥æœŸ</th>
        </tr>
      </thead>
      <tbody>
  `;
  arr.forEach((r, i)=>{
    const d = new Date(r.ts);
    const ds = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`;
    html += `
      <tr>
        <td><span class="rankBadge">${i+1}</span></td>
        <td>${escapeHtml(r.name)}</td>
        <td><b>${r.score}</b></td>
        <td>${fmtTime(r.remain)}</td>
        <td>${ds}</td>
      </tr>
    `;
  });
  html += `</tbody></table>`;
  boardTable.innerHTML = html;
}
function openBoard(){
  renderLB();
  boardModal.style.display = "flex";
}
function closeBoard(){
  boardModal.style.display = "none";
}
openBoardBtn.addEventListener("click", openBoard);
closeBoardBtn.addEventListener("click", closeBoard);
boardModal.addEventListener("click", (e)=>{ if(e.target === boardModal) closeBoard(); });

/* ===================== ç±ƒå­æç¤º ===================== */
function clearBasketsGlow(){
  Object.values(basketEls).forEach(b=>b.classList.remove("glow-ok","glow-bad"));
}
function glowBasket(key, ok){
  clearBasketsGlow();
  if(!basketEls[key]) return;
  basketEls[key].classList.add(ok ? "glow-ok" : "glow-bad");
  setTimeout(clearBasketsGlow, 220);
}

/* ===================== âœ… ç”¢ç”Ÿã€Œä¸é‡ç–Šã€çš„å‡ºç”Ÿåº§æ¨™ ===================== */
let spawnPoints = [];
function resetSpawnPoints(){ spawnPoints = []; }
function getSafeTop(){
  return (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--panelSafeTop')) || 210);
}
function getMinGap(){
  return (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--balloonMinGap')) || 96);
}
function farEnough(x,y, gap){
  for(const p of spawnPoints){
    const dx = x - p.x, dy = y - p.y;
    if((dx*dx + dy*dy) < gap*gap) return false;
  }
  return true;
}
function pickSpawnXY(){
  const skyR = sky.getBoundingClientRect();
  const safeTop = getSafeTop();
  const gap = getMinGap();

  const minX = 24;
  const maxX = skyR.width - 120;
  const minY = safeTop + 18;
  const maxY = Math.min(skyR.height - 260, safeTop + 420);

  for(let t=0; t<60; t++){
    const x = Math.random()*(maxX-minX)+minX;
    const y = Math.random()*(maxY-minY)+minY;
    if(farEnough(x,y,gap)){
      spawnPoints.push({x,y});
      return {x,y};
    }
  }
  const x = Math.random()*(maxX-minX)+minX;
  const y = Math.random()*(maxY-minY)+minY;
  spawnPoints.push({x,y});
  return {x,y};
}

/* ===================== æ°£çƒç”Ÿæˆ ===================== */
function createBalloon(data, idx){
  const container = document.createElement('div');
  container.className = 'balloon';

  const {x, y} = pickSpawnXY();
  container.style.left = x + 'px';
  container.style.top  = y + 'px';

  const body = document.createElement('div');
  body.className = 'balloon-body';
  body.innerText = data.txt;

  const hue = (idx * 37 + Math.random()*40) % 360;
  body.style.backgroundColor = `hsl(${hue}, 78%, 58%)`;

  const string = document.createElement('div');
  string.className = 'balloon-string';

  container.appendChild(body);
  container.appendChild(string);

  container.dataset.target = data.target;
  container.dataset.txt = data.txt;

  container.dataset.vx = (Math.random() < 0.5 ? -1 : 1) * (Math.random()*(0.18-0.08)+0.08);
  container.dataset.vy = -(Math.random()*(0.14-0.06)+0.06);
  container.dataset.phase = String(Math.random() * Math.PI * 2);

  makeDraggable(container);
  sky.appendChild(container);
}

/* ===================== æ”¾å…¥ç±ƒå­ï¼šåœ¨æ¡†å‰ ===================== */
function snapToBasket(balloonEl, key){
  const br = basketEls[key].getBoundingClientRect();
  const skyR = sky.getBoundingClientRect();

  const x = (br.left + br.right)/2 - skyR.left;
  const y = (br.top + br.bottom)/2 - skyR.top;

  balloonEl.style.left = (x - 36) + "px";
  balloonEl.style.top  = (y - 112) + "px";
  balloonEl.style.zIndex = 80;
  balloonEl.classList.add("placed");
}

/* ===================== å‘½ä¸­åˆ¤å®š ===================== */
function getBasketHitKey(balloonEl){
  const r = balloonEl.getBoundingClientRect();
  const cx = (r.left + r.right)/2;
  const cy = (r.top + r.bottom)/2;

  for(const key of Object.keys(basketEls)){
    const br = basketEls[key].getBoundingClientRect();
    const inX = cx >= br.left && cx <= br.right;
    const inY = cy >= (br.top - 46) && cy <= (br.bottom + 10);
    if(inX && inY) return key;
  }
  return null;
}

/* ===================== âœ… æ­£è§£åˆ¤æ–·ï¼ˆåªçœ‹ã€Œæ–‡å­—ã€ï¼‰ ===================== */
function isCorrectByText(hitKey, txt){
  if(!currentQuestion || !currentQuestion.correct) return false;
  if(hitKey === "ref") return txt === currentQuestion.correct.ref;
  if(hitKey === "comp") return txt === currentQuestion.correct.comp;
  if(hitKey === "val") return (currentQuestion.correct.valAccept || []).includes(txt);
  return false;
}

/* ===================== åˆå§‹åŒ–é¡Œç›® ===================== */
function initQuestion(){
  sky.querySelectorAll('.balloon').forEach(b => b.remove());
  resetSpawnPoints();

  placedNeeded = new Set();

  currentQuestion = makeQuestion();
  questText.innerText = currentQuestion.text;

  msgText.innerText = "å…ˆåˆ¤æ–·èª°æ˜¯åŸºæº–é‡(1)ã€èª°æ˜¯æ¯”è¼ƒé‡ï¼Œå†æŠŠã€ç®—å¼ã€ä¹Ÿé€é€²ç±ƒå­ã€‚";
  msgText.style.color = "#111827";

  const shuffled = [...currentQuestion.balloons].sort(()=>Math.random()-0.5);
  shuffled.forEach((b, i) => createBalloon(b, i));
}

/* ===================== éé—œ ===================== */
function checkWin(){
  if(["ref","comp","val"].every(t => placedNeeded.has(t))){
    msgText.innerText = "ğŸŠ ä¸‰å¤§è§’è‰²é›†é½Šï¼ä¸‹ä¸€é¡Œï½";
    msgText.style.color = "var(--ok)";
    addScore(15);
    setTimeout(()=>{ if(running) initQuestion(); }, 600);
  }
}

/* ===================== æ‹–æ‹‰ ===================== */
function makeDraggable(el){
  let dragging = false;
  let offsetX = 0, offsetY = 0;
  let activePointerId = null;

  const onPointerDown = (e) => {
    if(!running || paused) return;
    if(el.classList.contains("placed")) return;
    dragging = true;
    el.classList.add("dragging");
    el.setPointerCapture?.(e.pointerId);
    activePointerId = e.pointerId;

    const r = el.getBoundingClientRect();
    const skyR = sky.getBoundingClientRect();
    el.style.left = (r.left - skyR.left) + "px";
    el.style.top  = (r.top  - skyR.top ) + "px";

    const rr = el.getBoundingClientRect();
    offsetX = e.clientX - rr.left;
    offsetY = e.clientY - rr.top;
  };

  const onPointerMove = (e) => {
    if(!dragging) return;
    if(activePointerId !== null && e.pointerId !== activePointerId) return;

    const skyR = sky.getBoundingClientRect();
    const x = e.clientX - skyR.left - offsetX;
    const y = e.clientY - skyR.top  - offsetY;

    const maxX = skyR.width  - 20;
    const maxY = skyR.height - 170;
    const safeTop = getSafeTop();

    el.style.left = clamp(x, 0, maxX) + "px";
    el.style.top  = clamp(y, safeTop, maxY) + "px";
  };

  const onPointerUp = (e) => {
    if(!dragging) return;
    if(activePointerId !== null && e.pointerId !== activePointerId) return;

    dragging = false;
    el.classList.remove("dragging");
    activePointerId = null;

    const hitKey = getBasketHitKey(el);
    if(!hitKey){
      msgText.innerText = "ğŸ«§ ä¸Ÿåœ¨ç©ºä¸­ä¸ç®—ï½æŠŠå®ƒé€é€²ç±ƒå­ã€‚";
      msgText.style.color = "#111827";
      return;
    }

    const target = el.dataset.target;
    const txt = el.dataset.txt;

    if(hitKey !== target){
      glowBasket(hitKey, false);
      msgText.innerText = "âŒ ç±ƒå­ä¸å°ï¼å†çœ‹æ¸…æ¥šï½";
      msgText.style.color = "var(--bad)";
      addScore(-3);

      const skyR = sky.getBoundingClientRect();
      const safeTop = getSafeTop();
      el.style.top = (Math.random()*(240-20)+safeTop+20) + "px";
      el.style.left = (Math.random()*(skyR.width - 180)+40) + "px";
      return;
    }

    const ok = isCorrectByText(hitKey, txt);

    if(ok){
      glowBasket(hitKey, true);
      snapToBasket(el, hitKey);
      placedNeeded.add(hitKey);

      msgText.innerText = "â­ æ­£ç¢ºï¼å†æŠŠå¦å¤–å…©å€‹ä¹Ÿé€é€²å»ï½";
      msgText.style.color = "var(--ok)";
      addScore(10);

      checkWin();
      return;
    }

    glowBasket(hitKey, false);
    msgText.innerText = "ğŸª¤ é€™é¡†ä¸æ˜¯æ­£è§£ï½æ›ä¸€é¡†ï¼";
    msgText.style.color = "var(--bad)";
    addScore(-5);

    const skyR = sky.getBoundingClientRect();
    const safeTop = getSafeTop();
    el.style.top = (Math.random()*(260-20)+safeTop+20) + "px";
    el.style.left = (Math.random()*(skyR.width - 200)+40) + "px";
  };

  el.addEventListener("pointerdown", onPointerDown, {passive:false});
  window.addEventListener("pointermove", onPointerMove, {passive:false});
  window.addEventListener("pointerup", onPointerUp, {passive:false});
}

/* ===================== é£„ç§» + äº’æ–¥é¿å…é‡ç–Š ===================== */
let rafId = null;
function floatLoop(){
  if(!running){
    rafId = requestAnimationFrame(floatLoop);
    return;
  }

  const safeTop = getSafeTop();
  const minGap = getMinGap();
  const skyR = sky.getBoundingClientRect();
  const maxX = skyR.width - 20;
  const maxY = skyR.height - 185;

  const balloons = Array.from(document.querySelectorAll('.balloon'));
  const t = performance.now() * 0.0016;

  for(let i=0;i<balloons.length;i++){
    const b = balloons[i];
    if(b.classList.contains("placed") || b.classList.contains("dragging")) continue;

    const x = parseFloat(b.style.left) || 0;
    const y = parseFloat(b.style.top) || 0;

    const vx = parseFloat(b.dataset.vx || "0.12");
    const vy = parseFloat(b.dataset.vy || "-0.10");
    const phase = parseFloat(b.dataset.phase || "0");

    const dx = Math.sin(t + phase + i) * 1.0;
    const dy = Math.cos(t + phase + i*1.2) * 0.7;
    b.style.transform = `translate(${dx}px, ${dy}px)`;

    if(paused) continue;

    let nx = x + vx;
    let ny = y + vy;

    if(ny < safeTop) ny = safeTop + (Math.random()*(220-40)+40);
    if(nx < 0){ nx = 0; b.dataset.vx = String(Math.abs(vx)); }
    if(nx > maxX){ nx = maxX; b.dataset.vx = String(-Math.abs(vx)); }
    if(ny > maxY) ny = maxY;

    b.style.left = nx + "px";
    b.style.top  = ny + "px";
  }

  if(!paused){
    for(let i=0;i<balloons.length;i++){
      const a = balloons[i];
      if(a.classList.contains("placed") || a.classList.contains("dragging")) continue;

      const ax = parseFloat(a.style.left)||0;
      const ay = parseFloat(a.style.top)||0;

      for(let j=i+1;j<balloons.length;j++){
        const b = balloons[j];
        if(b.classList.contains("placed") || b.classList.contains("dragging")) continue;

        const bx = parseFloat(b.style.left)||0;
        const by = parseFloat(b.style.top)||0;

        const dx = bx-ax, dy = by-ay;
        const dist2 = dx*dx + dy*dy;
        const gap2 = (minGap*0.88)*(minGap*0.88);

        if(dist2 > 0 && dist2 < gap2){
          const dist = Math.sqrt(dist2);
          const push = (minGap*0.88 - dist) * 0.18;
          const ux = dx / dist;
          const uy = dy / dist;

          const nax = clamp(ax - ux*push, 0, maxX);
          const nay = clamp(ay - uy*push, safeTop, maxY);
          const nbx = clamp(bx + ux*push, 0, maxX);
          const nby = clamp(by + uy*push, safeTop, maxY);

          a.style.left = nax + "px";
          a.style.top  = nay + "px";
          b.style.left = nbx + "px";
          b.style.top  = nby + "px";
        }
      }
    }
  }

  rafId = requestAnimationFrame(floatLoop);
}

/* ===================== æš«åœ / ç¹¼çºŒ ===================== */
function togglePause(){
  if(!running) return;
  paused = !paused;
  pauseOverlay.style.display = paused ? "flex" : "none";
  pauseBtn.innerHTML = paused
    ? `<i class="fa-solid fa-play"></i>ç¹¼çºŒ`
    : `<i class="fa-solid fa-pause"></i>æš«åœ`;

  msgText.innerText = paused ? "â¸ï¸ æš«åœä¸­ï½å…ˆå–˜å£æ°£å†é–‹é£†ã€‚" : "â–¶ï¸ ç¹¼çºŒï¼æŠŠæ°£çƒé€å›å®¶ï½";
  msgText.style.color = paused ? "var(--muted)" : "#111827";
}
pauseBtn.addEventListener("click", togglePause);

/* ===================== é–‹å§‹ / çµæŸ / é‡ä¾† ===================== */
let score = 0;
function setScore(v){
  score = Math.max(0, v);
  uiScore.textContent = String(score);
}
function addScore(delta){ setScore(score + delta); }

function begin(){
  playerName = nameInput.value.trim();
  if(!playerName){
    gateMsg.textContent = "åå­—è¦å¡«å•¦ï½ä¸ç„¶æ’è¡Œæ¦œè¦å«ä½ ã€ŒåŒ¿åç‹è€…ã€å— ğŸ¥²";
    nameInput.focus();
    return;
  }
  gateMsg.textContent = "";
  gate.style.display = "none";

  uiName.textContent = playerName;
  setScore(0);

  running = true;
  paused = false;
  pauseOverlay.style.display = "none";
  pauseBtn.innerHTML = `<i class="fa-solid fa-pause"></i>æš«åœ`;

  initQuestion();
  startTimer();
  if(!rafId) floatLoop();
}

function endGame(){
  running = false;
  paused = false;
  stopTimer();

  msgText.innerText = "â³ æ™‚é–“åˆ°ï¼æˆç¸¾å·²è¨˜éŒ„åˆ°æ’è¡Œæ¦œã€‚";
  msgText.style.color = "#111827";

  upsertScore({ name: playerName, score, remain: Math.max(0, remain), ts: Date.now() });
  openBoard();
}

function resetGame(){
  if(!playerName) return;
  stopTimer();
  running = true;
  paused = false;
  pauseOverlay.style.display = "none";
  pauseBtn.innerHTML = `<i class="fa-solid fa-pause"></i>æš«åœ`;

  setScore(0);
  initQuestion();
  startTimer();

  msgText.innerText = "é‡æ–°é–‹å±€ï¼é€™æ¬¡æŠŠé™·é˜±æ°£çƒç•¶ä½œåæ´¾è™•ç† ğŸ˜¼";
  msgText.style.color = "#111827";
}

startBtn.addEventListener("click", begin);
nameInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") begin(); });
resetBtn.addEventListener("click", resetGame);

/* ç©ºç™½éµæš«åœ */
window.addEventListener("keydown", (e)=>{
  if(e.code === "Space"){
    e.preventDefault();
    togglePause();
  }
});

/* resizeï¼šæŠŠæ°£çƒæ‹‰å›å®‰å…¨å€ */
window.addEventListener("resize", ()=>{
  const skyR = sky.getBoundingClientRect();
  const maxX = skyR.width - 20;
  const maxY = skyR.height - 185;
  const safeTop = getSafeTop();

  document.querySelectorAll('.balloon').forEach(b=>{
    if(b.classList.contains("placed")) return;
    const x = parseFloat(b.style.left) || 0;
    const y = parseFloat(b.style.top) || 0;
    b.style.left = clamp(x, 0, maxX) + "px";
    b.style.top  = clamp(y, safeTop, maxY) + "px";
  });
});

/* åˆå§‹ï¼šç­‰åå­— */
uiTime.textContent = fmtTime(ROUND_SECONDS);
</script>
</body>
</html>
